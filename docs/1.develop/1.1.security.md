安全
====

安全是指保护账户安全，通常分为认证和授权两个部分，认证即处理登录时的各种情况，授权即处理操作时的各种情况。

---

## 设计思路

基于前后端分离模式，前端通过`Vue Router`框架管理菜单和页面，后端使用`Spring Security`框架管理接口和数据。

当账户认证成功后，可以获取对应的菜单列表，通过菜单数据来动态渲染路由，找到页面入口。

当账户发起请求时，后端会根据账户对应的权限列表，过滤未经授权的请求，避免非法访问。

### 认证

默认情况下，`Spring Security`内置登录页面，并且支持自定义登录页面和逻辑，以及自定义重定向相关的功能，比如错误页面、注销接口等。

由于前端部署在单独的一个容器中，可能与后端存在不同的域名及端口，因此会触发跨域限制。

虽然`Vue Router`本身可以绕开跨域限制，但`Spring Security`内置的重定向功能，又会跳出`Vue Router`的管理范围，所以必须进行自定义。

而使用`Spring Security`框架自定义认证逻辑非常简单，只需要将`HttpSecurity`中的`formLogin`、`exceptionHandling`、`sessionManagement`、`logout`方法进行自定义即可。

参考代码如下：

```java

@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
@Configuration
public class SecurityConfiguration {

    @Bean
    public SecurityFilterChain webFilterChain(HttpSecurity http,
                                              LoginFailureHandler loginFailureHandler,
                                              LoginSuccessHandler loginSuccessHandler) {
        return http
                .authorizeRequests(urlRegistry -> urlRegistry
                        .anyRequest().authenticated())
                .formLogin(loginConfigurer -> loginConfigurer
                        .failureHandler(loginFailureHandler)
                        .successHandler(loginSuccessHandler))
                .exceptionHandling(handlingConfigurer -> handlingConfigurer
                        .accessDeniedHandler(new AccessDeniedHandlerImpl())
                        .authenticationEntryPoint(new Http403ForbiddenEntryPoint()))
                .sessionManagement(managementConfigurer -> managementConfigurer
                        .invalidSessionStrategy((request, response) ->
                                response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "invalidSessionStrategy"))
                        .sessionConcurrency(controlConfigurer -> controlConfigurer
                                .maximumSessions(1)
                                .expiredSessionStrategy(event ->
                                        event.getResponse().sendError(HttpServletResponse.SC_UNAUTHORIZED, "expiredSessionStrategy"))))
                .logout(logoutConfigurer -> logoutConfigurer
                        .logoutSuccessHandler(new HttpStatusReturningLogoutSuccessHandler())
                        .deleteCookies("JSESSIONID"))
                .csrf().disable()
                .build();
    }
}
```

其中，`LoginFailureHandler`实现了`AuthenticationFailureHandler`接口，主要是对`AuthenticationException`异常进行分析，返回对应的错误提示。

而`LoginSuccessHandler`实现了`AuthenticationSuccessHandler`接口，主要返回一个凭据给前端用于确认登录成功。

前端向后端发起请求时，会自动携带名为`SESSION`的`Cookie`数据，后端通过`Spring Security`分析当前请求，找到所属会话及对应账户，完成认证。

### 授权

授权实际上分为两部分，其一为后端返回给前端的菜单数据，其二为后端定义的权限数据。

正常情况下，`Vue Router`通过菜单数据渲染路由，用户只能看到自己的路由，没有权限的路由无法看到。

通过路由可以跳转到对应页面，页面中会展示用户有权限的操作按钮，没有权限的操作按钮将不展示。

这些操作按钮可能关联一个弹窗、一次请求或是其他相关操作。

对于操作按钮关联的请求来说，必须是账户已授权才能访问，所以后端需要在过滤器中校验相关权限数据。

至于更细粒度的数据权限，可以通过`spring-security-acl`框架进行管理，它将在查询数据库时进行过滤，而不是在内存中过滤。
